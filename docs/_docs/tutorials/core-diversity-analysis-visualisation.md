---
title: Core diversity analysis and visualisation
---

# Core diversity analysis and visualisation

This tutorial steps through two main components:

1) Taxonomy barplots 
2) Diversity analysis and visualisation, which performs
   - alpha-diversity analyses
   - beta-diversity analyses
   - differential abundance analysis

## Tutorial data

The data set used for this tutorial is the same as that processed in the [Data processing without Singularity]({{ site.baseurl }}/docs/tutorials/../../../tutorial-no-singularity#tutorial-data) tutorial.

This data is from ...

In the previous tutorial, we only processed a subset of the samples (n=9 output n=56). In this tutorial we will be working with the full data set which has already been processed for you.

----

# Preparation

- download the processed data for this tutorial (n=56 samples)
  - *Note* to keep the download size manageable only the processed output (feature tables) are provided in the download. Intermediate files are not provided and can be generated by following the [Data processing without Singularity]({{ site.baseurl }}/docs/tutorials/../../../tutorial-no-singularity#tutorial-data) tutorial.
- extract the archived file
- navigate to the `output` folder
- enter the following command to check the directory structure matches

```bash
$ wget ___
$ tar xf ___
$ cd output
$ tree .
```

- check that you have the following directory structure (only a subset of the files are shown below)

```
.
├── QC_module
│   ├── QCReport -> ../../QC_module/QCReport
│   │   ├── SRR17380113.json
│   │   ├── SRR17380113.outreport.html
│   │   ├── SRR17380114.json
│   │   ├── SRR17380114.outreport.html
...
│   │   ├── SRR17380248.json
│   │   ├── SRR17380248.outreport.html
│   │   ├── SRR17380249.json
│   │   └── SRR17380249.outreport.html
│   └── QC_report.csv -> ../../QC_module/QC_report.csv
└── Taxonomy_profiling
    └── featureTables -> ../../Taxonomy_profiling/featureTables
        ├── bracken_FT_class_counts
        ├── bracken_FT_class_relAbund
...
        ├── bracken_FT_phylum_counts
        ├── bracken_FT_phylum_relAbund
        ├── bracken_FT_species_counts
        ├── bracken_FT_species_relAbund
        └── bracken_FT_species_relAbund
```

Brief overview of the directory and files

- `metadata.tsv` is a tab-seperated text file of the study metadata
- `QC_module/QCReport` directory contains output from the QC module in the processing step (namely output from `fastp`)
  - `QC_module/QC_report.csv` is a summary report of the number of reads remaining per sample after each QC step
- `Taxonomy_profiling/featureTables` directory contains the output from Kraken2 and abundance estimation of Bracken. The text files are feature abundance tables for each taxonomic ranks from phylum down to species. As some analysis tools might require feature table input to be discrete counts while others might require relative abundances, two tables are provided for each taxonomic rank:
    - `_count` contain discrete counts of feature (row) per samples (columns), and
    - `_relAbund` contain the relative abundances of feature (row) per sample (columns)



For this tutorial, confirm you have the following 3 files:

```
$ ls metadata.tsv
$ ls Taxonomy_profiling/featureTables/bracken_FT_species_counts
$ ls Taxonomy_profiling/featureTables/bracken_FT_species_relAbund
```


----

# Analysis 1: Taxonomy barplots

## a) Create output directory

First, we will create an `analysis` directory to store the output

- in the terminal, within the `output/` directory, enter the following command

```bash
$ mkdir analysis
$ ls -lh
```

- you should see the following directory structure

```bash
total 0
drwx------. 2 user unsw 10 Jul 20 13:11 analysis
drwx------. 2 user unsw 55 Jul 20 13:01 QC_module
drwx------. 2 user unsw 35 Jul 20 13:01 Taxonomy_profiling
```

## b) Generate taxonomy bar plots

- in the terminal, enter the following command (without the backslash `\`)
  - *note* the backslash (`\`) is for readability and allows the command to be enetered on separate lines, you can remove the backslash
 
```bash
$perl taxa_plot.pl Taxonomy_profiling/featureTables/bracken_FT_species_relAbund \
metadata.tsv \
lab:labA:labB:labC \
analysis \
LAB 7 8 6
```

**Required parameters**

```
USAGE:
perl visualisation/taxa_plot.pl <feature_table.tsv> <metadata.tsv> <column_group:g1:g2> <output_dir> <output_prefix> <top_N> <figure_width> <figure_height>
```

- note that the parameters **must** be in the order presented

| Parameters | Description |
|:-----------|:------------|
| `<feature_table.tsv>` | path to the relative abundance feature table, we are using the **species** feature table in this step|
| `<metadata.tsv>` | path to the study metadata table (tab-seperated file) |
| `<column_group:g1:g2>` | this is the grouping information from the `metadata.tsv` file in the format: `group_column:group1:group2:etc`. In our example, the column heading is `lab` and there are 3 groups: `labA`, `labB` and `labC`. The data is case sensitive. |
| `<output_dir>` | path to output directory where results are stored. In our example we store it in the `analysis/` directory which was created previously |
| `<output_prefix>` | prefix that will be used for output files. In our example, our files will have `LAB` as the prefix |
| `<top_N>` | top N taxa to colour in the stack bar plot, remaining taxa are grouped together as 'Other' |
| `<figure_width>` | output figure width (inches) |
| `<figure_height>` | output figure height (inches) |


**Expected output**

- check output files

```
$ ls -lh analysis
```

- expected output

```
-rw-------. 1 user unsw  43K Jul 19 11:37 LABS.select.average.table.txt
-rw-------. 1 user unsw  464 Jul 19 11:37 LABS.select.average.top_7_seperategroup.table.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.average.top_7_seperategroup.table.txt.7.R
-rw-------. 1 user unsw  424 Jul 19 11:37 LABS.select.average.top_7.table.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.average.top_7.table.txt.7.R
-rw-------. 1 user unsw  389 Jul 19 11:37 LABS.select.meta.txt
-rw-------. 1 user unsw  717 Jul 19 11:37 LABS.select.table_top_7_seperategroup.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.table_top_7_seperategroup.txt.7.R
-rw-------. 1 user unsw  647 Jul 19 11:37 LABS.select.table_top_7.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.table_top_7.txt.7.R
-rw-------. 1 user unsw  49K Jul 19 11:37 LABS.select.table.txt
-rw-------. 1 user unsw 5.4K Jul 19 11:37 LABS.select.top_7_.barchart.pdf
-rw-------. 1 user unsw 5.5K Jul 19 11:37 LABS.select.top_7_seperategroup.barchart.pdf
```

There are 13 output files, where the PDFs are the graphical outputs:




Other files:

| Output file | Description |
|:------------|:------------|
|*.average.table.txt | seiong |


----

# Analysis 1: Core diversity analysis and visualisation

- in the terminal enter the following command

```
python visualisation.py --feature-table path/to/taxonomy_profiling/feature-abundance-table \
--metadata path/to/project/metadata.tsv \
--study-groups comma,separated,list \
--output-dir path/to/output > visualisation.log
```

----

