---
title: Core diversity analysis and visualisation
---

# Core diversity analysis and visualisation

This tutorial steps through two main components:

1. Taxonomy barplots 
2. Diversity analysis and visualisation, which performs
   - alpha-diversity analyses
   - beta-diversity analyses
   - differential abundance analysis

## Tutorial data

The data set used for this tutorial is the same used in the two Data processing tutorials, from [Tourlousse, *et al.* (2022)](https://journals.asm.org/doi/10.1128/spectrum.01915-21){:target="_blank"}.

> This data set consists of two mock communities: *DNA-mock* and *Cell-mock*.
> 
> The mock communities consists of bacteria that are mainly detected the human gastrointestinal tract ecosystem with a small mixture of some skin microbiota. The data was processed in three different labs: A, B and C.  In the previous tutorial, , we only processed a subset of the samples (n=9). In this tutorial we will be working with the full data set which has been pre-processed using the same pipeline. In total there were 56 samples of which 4 samples fell below the abundance threshold and therefore the final taxonomy abundance table has 52 samples. We will train the random forest classifier to distinguish between the three labs.

In the previous tutorial, we only processed a subset of the samples (n=9). In this tutorial we will work with the full data set which has already been processed for you. There are 52 samples (4 samples did not have any Kraken2 output).

----

# Getting started

This tutorial uses the Singularity version of the pipeline, which is detailed in the [Install MIMA Pipeline Singularity container]({{site.baseurl}}/docs/installation) tutorial

- Remember to start an *interactive* PBS job
- Set the `SANDBOX` environment variable
- If needed, [set the `SINGULARITY_BIND` environment variable](tutorial-with-singularity#pbs-configuration-files)


# Data preparation

- Download [taxonomy-feature-table.tar.gz](https://github.com/xychua/test-gitpages/raw/master/examples/taxonomy-feature-table.tar.gz) the processed data for this tutorial (n=52 samples)
  - *Note* to keep the download size manageable only the processed output (feature tables) are provided in the download. Intermediate files are not provided and can be generated by following the [Data processing without Singularity]({{ site.baseurl }}/docs/tutorials/../../../tutorial-no-singularity#tutorial-data) tutorial.
- Extract the archived file
- Navigate to the `output` folder
- Check the directory structure matches

```
$ mkdir vis-tutorial
$ cd vis-tutorial
$ wget https://github.com/xychua/test-gitpages/raw/master/examples/taxonomy-feature-table.tar.gz
$ tar xf taxonomy-feature-table.tar.gz
$ tree .
```

Only a subset of the files are shown below and `...` means "and others"

```
.
├── metadata.tsv
├── taxonomy-feature-table.tar.gz
└── Taxonomy_profiling
    └── featureTables
        ├── bracken_FT_class
        ├── bracken_FT_class_counts
        ├── bracken_FT_class_relAbund
        ├── ...
        ├── bracken_FT_species
        ├── bracken_FT_species_counts
        ├── bracken_FT_species_relAbund
        ├── combine_bracken_class.log
        ├── ...
        ├── combine_bracken_species.log
        └── generate_bracken_feature_table.py
```

Brief overview of the directory and files

- `metadata.tsv` is a tab-separated text file of the study metadata
- `Taxonomy_profiling/featureTables` directory contains the output from Kraken2 and abundance estimation of Bracken. The text files are feature abundance tables for each taxonomic ranks from phylum down to species. As some analysis tools might require feature table input to be discrete counts while others might require relative abundances, two tables are provided for each taxonomic rank:
    - `_count` contain discrete counts of feature (row) per samples (columns), and
    - `_relAbund` contain the relative abundances of feature (row) per sample (columns)


For this tutorial, confirm you have the following 3 files:

```
$ ls metadata.tsv
$ ls Taxonomy_profiling/featureTables/bracken_FT_species_counts
$ ls Taxonomy_profiling/featureTables/bracken_FT_species_relAbund
```


----

# Analysis 1: Taxonomy barplots

## a) Create output directory

First, we will create an `analysis` directory to store the output

```bash
$ mkdir analysis
$ tree -d .
```

You should see the following directory structure

```
.
├── analysis
└── Taxonomy_profiling
    └── featureTables

```

## b) Generate taxonomy bar plots

- Enter the following command, all on one line without the backslash `\`
  - the backslash (`\`) is for readability and tells the terminal the command is not yet finished
 
```bash
$ singularity run --app mima-vis-taxa $SANDBOX \
Taxonomy_profiling/featureTables/bracken_FT_species_relAbund \
metadata.tsv \
lab:labA:labB:labC \
analysis \
LAB 7 8 6
```

**Parameters explained**

```
USAGE:
perl taxa_plot.pl <feature_table.tsv> <metadata.tsv> <column_group:g1:g2> <output_dir> <output_prefix> <top_N> <figure_width> <figure_height>
```

{% include alert.html type="danger" title="! Note" content="The parameters must be in the same order presented above and described below" %}

| Parameters | Description |
|------------|-------------|
| `<feature_table.tsv>` | path to the relative abundance feature table, we are using the **species** feature table in this step|
| `<metadata.tsv>` | path to the study metadata table (tab-seperated file) |
| `<column_group:g1:g2>` | this is the grouping information from the `metadata.tsv` file in the format: `group_column:group1:group2:etc`. In our example, the column heading is `lab` and there are 3 groups: `labA`, `labB` and `labC`. The data is case sensitive. |
| `<output_dir>` | path to output directory where results are stored. In our example we store it in the `analysis/` directory which was created previously |
| `<output_prefix>` | prefix that will be used for output files. In our example, our files will have `LAB` as the prefix |
| `<top_N>` | top N taxa to colour in the stack bar plot, remaining taxa are grouped together as 'Other' |
| `<figure_width>` | output figure width (inches) |
| `<figure_height>` | output figure height (inches) |


**Expected output**

Check output files

```
$ ls analysis
```

```
-rw-------. 1 user unsw  43K Jul 19 11:37 LABS.select.average.table.txt
-rw-------. 1 user unsw  464 Jul 19 11:37 LABS.select.average.top_7_seperategroup.table.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.average.top_7_seperategroup.table.txt.7.R
-rw-------. 1 user unsw  424 Jul 19 11:37 LABS.select.average.top_7.table.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.average.top_7.table.txt.7.R
-rw-------. 1 user unsw  389 Jul 19 11:37 LABS.select.meta.txt
-rw-------. 1 user unsw  717 Jul 19 11:37 LABS.select.table_top_7_seperategroup.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.table_top_7_seperategroup.txt.7.R
-rw-------. 1 user unsw  647 Jul 19 11:37 LABS.select.table_top_7.txt
-rw-------. 1 user unsw 1.6K Jul 19 11:37 LABS.select.table_top_7.txt.7.R
-rw-------. 1 user unsw  49K Jul 19 11:37 LABS.select.table.txt
-rw-------. 1 user unsw 5.4K Jul 19 11:37 LABS.select.top_7_.barchart.pdf
-rw-------. 1 user unsw 5.5K Jul 19 11:37 LABS.select.top_7_seperategroup.barchart.pdf
```

There are 13 output files, where the PDFs are the graphical outputs:


Other files:

| Output file | Description |
|-------------|-------------|
| \*.average.table.txt |  |
| \*.average.top_7_separategroup\* |  |
| \*.average.top_7\* | |
| \*.meta.txt | |
| \*.table_top_7_separategroup.\* | 
| \*.table_top_7\* |  |
| \*.pdf | stacked bar plots |

PDF figures below

<table class="table table-borderless">
<tr>
  <td><img src="{{site.baseurl}}/assets/img/tutorials/visualisation/LABS.select.average.top_7_.barchart.png" height="75%"/></td>
  <td><img src="{{site.baseurl}}/assets/img/tutorials/visualisation/LABS.select.average.top_7_seperategroup.barchart.png" height="75%"/></td>
</tr>
<tr>
  <td><img src="{{site.baseurl}}/assets/img/tutorials/visualisation/LABS.select.top_7_.barchart.png" height="75%"/></td>
  <td><img src="{{site.baseurl}}/assets/img/tutorials/visualisation/LABS.select.top_7_seperategroup.barchart.png" height="75%"/></td>
</tr>
</table>

----

# Analysis 1: Core diversity analysis and visualisation

- Enter the following command, all on one line without the backslash `\`
  - the backslash (`\`) is for readability and tells the terminal the command is not yet finished

```
$ singularity run --app mima-visualiasation $SANDBOX \
--feature-table Taxonomy_profiling/featureTables/bracken_FT_species_counts \
--metadata metadata.tsv \
--study-groups lab \
--output-dir analysis > visualisation.log
```

**Parameters explained**

| Parameters      | Description |
|-----------------|-------------|
| `feature-table` | path to the feature abundance table |
| `metadata`      | path to the study metadata table |
| `study-groups`  | Comma separated list of column names in the metadata table which contain the study groups of interest |
| `output-dir`    | path to output directory |


**Expected output**

```
$ tree -d analysis
```

The output directory structure should resemble the following with four sub-directories which are described below

```
analysis/
├── Kraken
├── Kraken_alpha
│   ├── boxplots
│   │   ├── corrected_sig
│   │   ├── non_sig
│   │   └── uncorrected_sig
│   └── wilcox-pairwise
├── Kraken_beta
│   ├── permanova
│   └── plots
└── Kraken_diff-abundance
    ├── barplot
    ├── boxplots
    │   ├── corrected_sig
    │   └── uncorrected_sig
    ├── volcano
    └── wilcox-pairwise
```


**Output**

| Directory / Files |  Description              |
|-------------------|---------------------------|
| Kraken/           | directory contains two text files: (i) `otu_matrix.txt` - the feature abundance table and (ii) `TaxProfileWithMeta.txt` - the feature abundance table concatenated with the study metadata provided by the `--metadata` parameter |
| Kraken_alpha/     | directory consisting the outputs from alpha-diversity analysis (see below) |
| Kraken_beta/      | directory consisting the otuputs from beta-diversity analysis (see below) |
| Kraken_diff-abundance/ | directory consisting the outputs from differential abundance analysis (see below) |

## Outputs explained

### Alpha-diversity analysis

The alpha diversity analysis contains two sub-directories:

1. `boxplots/` - contains boxplots of group comparisons as defined by the `--study-groups` parameter setting. If there are two groups then the Wilcox rank-sum test is performed, if there are more than two groups than the Kruskal-Wallis test is performed.
  
     - within this directory, comparisons are adjusted for multiple comparisons. Those that are significant after adjustment are put in the `corrected_sig/` directory; `non_sig/` contains results that are not significant after adjustment and `uncorrected_sig/` contains results that are significant before adjustment

2. `wilcox-pairwise/` - contains text output from Wilcox rank-sum test of pairwise group comparisons as specified by the `--study-groups` parameter setting

| Directory / Files |  Description              |
|:------------------|:--------------------------|
| alpha_diversity_raw_data.txt | |
| *_filter_table.txt | |
| *_kw_stat_summary.txt | |
| *_pairwise_dunn_test.txt | |

- Enter the following command to see the output for beta-analysis:

```
$ tree analysis/Kraken_alpha
```

In this tutorial, there are four alpha-diversities that are significant after adjustment: chao1, chao2, evenness and observed richness (shown below). There were four alpha-diversities that were not significant: Gini, inverse simpson, shannon and simpson indices.

```
analysis/Kraken_alpha
├── alpha_diversity_raw_data.txt
├── boxplots
│   ├── corrected_sig
│   │   ├── chao1_lab_dotplot.png
│   │   ├── chao2_lab_dotplot.png
│   │   ├── evenness_lab_dotplot.png
│   │   └── observed_lab_dotplot.png
│   ├── non_sig
│   │   ├── Gini_lab_dotplot.png
│   │   ├── invsimperson_lab_dotplot.png
│   │   ├── shannon_lab_dotplot.png
│   │   └── simperson_lab_dotplot.png
│   └── uncorrected_sig
├── lab_filter_table.txt
├── lab_kw_stat_summary.txt
├── lab_pairwise_dunn_test.txt
└── wilcox-pairwise
    ├── lab_labA_labB.wil.stat_summary.txt
    ├── lab_labA_labC.wil.stat_summary.txt
    └── lab_labB_labC.wil.stat_summary.txt
```

<table>
<tr>
  <td>
    <img src="{{site.baseurl}}/assets/img/tutorials/visualisation/observed_lab_dotplot.png" width="75%"/>
    <p>Comparison of alpha-diversity (observed richness) between the three labs.</p>
  </td>
  <td>
    <img src="{{site.baseurl}}/assets/img/tutorials/visualisation/evenness_lab_dotplot.png" width="75%"/>
    <p>Comparison of alpha-diversity (evenness) between the three labs.</p>
  </td>
</tr>
</table>

### Beta-diversity analysis

```
$ tree analysis/Kraken_beta
```

```
analysis/Kraken_beta/
├── permanova
│   └── lab_pairwise_adonis.results.tsv
└── plots
    ├── CA-Bray-Curtis-lab.png
    ├── CCA-Bray-Curtis-lab.png
    ├── DCA-Bray-Curtis-lab.png
    ├── NMDS-Bray-Curtis-lab.png
    ├── PCA-Bray-Curtis-lab.png
    ├── PCoA-Bray-Curtis-lab.png
    └── RDA-Bray-Curtis-lab.png
```

![PCoA plot of Bray-Curtis dissimilarity between the labs]({{site.baseurl}}/assets/img/tutorials/visualisation/PCoA-Bray-Curtis-lab.png){:height="50%" width="50%"}
<p>Principal co-ordinate analysis plot of the beta-diversity measured using Bray-Curtis dissimilarity between samples grouped by the three labs.</p>


### Differential abundance analysis

```
$ tree -d analysis/Kraken_diff-abundance/
```

```
analysis/Kraken_diff-abundance/
├── barplot
├── boxplots
│   ├── corrected_sig
│   └── uncorrected_sig
├── volcano
└── wilcox-pairwise
```

<table>
<tr>
  <td>
    <img src="{{site.baseurl}}/assets/img/tutorials/visualisation/s__Acetivibrio_A.ethanolgignens_lab_dotplot.png" width="75%"/>
    <p>Example of taxa deemed significantly different abundant between the labs.</p>
  </td>
  <td>
    <img src="{{site.baseurl}}/assets/img/tutorials/visualisation/s__Bifidobacterium.callitrichos_lab_dotplot.png" width="75%"/>
    <p>Example of taxa deemed significantly different abundant between the labs.</p>
  </td>
</tr>
</table>